<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CAMA CAMA｜住宿明細確認</title>

<style>
:root{
  --bg:#F6F1E9;
  --card:#ffffff;
  --line:#E3D8C8;
  --title:#EDE6DA;
  --text:#3C3A36;
  --muted:#7B746B;
  --btn:#2f2d2a;
}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
}
.wrap{max-width:900px;margin:0 auto;padding:18px;}
.brand{text-align:center;font-weight:800;margin:6px 0 10px;}
.barTitle{
  background:var(--btn);color:#fff;text-align:center;
  padding:12px;border-radius:14px;font-weight:800;
}
.card{
  background:#fff;border:1px solid var(--line);
  border-radius:18px;margin:12px 0;overflow:hidden;
}
.cardTitle{background:var(--title);padding:12px;font-weight:800;}
.cardBody{padding:14px;}
input,textarea,select{
  width:100%;padding:10px;border-radius:12px;
  border:1px solid var(--line);box-sizing:border-box;
}
textarea{min-height:70px;}
.tbl{width:100%;border-collapse:collapse;}
.tbl th,.tbl td{border:1px solid var(--line);padding:8px;}
button{
  padding:10px 14px;border-radius:14px;
  border:0;background:var(--btn);color:#fff;
  cursor:pointer;
}
.ghost{background:#fff;border:1px solid var(--line);color:var(--text);}
.btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
.small{font-size:12px;color:var(--muted);}
.status{margin-top:10px;font-size:14px;}
.ok{color:#1b7f3a;}
.bad{color:#b00020;}
canvas{width:100%;height:180px;border:1px solid var(--line);border-radius:12px;}
</style>
</head>

<body>
<div class="wrap">

<div class="brand">CAMA CAMA</div>
<div class="barTitle">住宿明細確認</div>

<!-- 日常紀錄 -->
<div class="card">
<div class="cardTitle">日常紀錄</div>
<div class="cardBody">

<div class="small">可依住宿天數新增（客人端預設只顯示前3天）</div>

<table class="tbl">
<thead>
<tr>
<th style="width:15%">日期</th>
<th style="width:30%">食慾</th>
<th style="width:20%">排便 / 排尿</th>
<th>備註</th>
</tr>
</thead>
<tbody id="daysTbody"></tbody>
</table>

<div class="btns">
<button type="button" class="ghost" id="addDayBtn">＋新增一天</button>
<button type="button" class="ghost" id="toggleDaysBtn" style="display:none;">
展開全部
</button>
</div>

</div>
</div>

<!-- 費用 -->
<div class="card">
<div class="cardTitle">費用明細</div>
<div class="cardBody">

<div id="feeRows"></div>

<div class="btns">
<button type="button" class="ghost" id="addFeeBtn">＋新增項目</button>
</div>

<div style="margin-top:10px;font-weight:800;">
總金額：$ <span id="feeTotal">0</span>
</div>

</div>
</div>

<!-- 客人確認 -->
<div class="card" id="confirmCard">
<div class="cardTitle">飼主確認與簽名</div>
<div class="cardBody">

<label>Email *</label>
<input id="confirm_email">

<label style="margin-top:10px;">
<input type="checkbox" id="confirm_record">
我已確認內容無誤
</label>

<div style="margin-top:10px;">
<canvas id="sig"></canvas>
<div class="btns">
<button type="button" class="ghost" id="clearBtn">清除簽名</button>
</div>
</div>

<label style="margin-top:10px;">簽名日期</label>
<input id="signed_date">

<div class="btns">
<button type="button" id="submitBtn">送出</button>
</div>

<div class="status" id="status"></div>

</div>
</div>

</div>

<script>
const GAS_URL="https://script.google.com/macros/s/AKfycbxcFQkQwLByRgvdw0cytzP3n8lU1hWCTmUz9L6AMvWGlnbk6i2xqcDLxcMLdCjisPsKzg/exec";

/* ---------- 日常紀錄 ---------- */
const daysTbody=document.getElementById("daysTbody");
let daysCollapsed=true;

function dayRowTpl(i){
const tr=document.createElement("tr");
tr.className="dayRow";
tr.dataset.idx=i;
tr.innerHTML=`
<td><input type="date" id="d${i}_date"></td>
<td>
早<select id="d${i}_am">
<option value="">-</option>
<option>良好</option><option>普通</option><option>不吃</option>
</select><br>
中<select id="d${i}_noon">
<option value="">-</option>
<option>良好</option><option>普通</option><option>不吃</option>
</select><br>
晚<select id="d${i}_pm">
<option value="">-</option>
<option>良好</option><option>普通</option><option>不吃</option>
</select>
</td>
<td>
<select id="d${i}_pee"><option value="">排尿</option><option>正常</option><option>異常</option></select><br>
<select id="d${i}_poo"><option value="">排便</option><option>正常</option><option>異常</option></select>
</td>
<td><textarea id="d${i}_remind"></textarea></td>
`;
return tr;
}

function addDay(){
const count=daysTbody.querySelectorAll(".dayRow").length;
daysTbody.appendChild(dayRowTpl(count+1));
updateCollapse();
}

function updateCollapse(){
const rows=[...daysTbody.querySelectorAll(".dayRow")];
const btn=document.getElementById("toggleDaysBtn");

if(rows.length>3){
btn.style.display="inline-block";
rows.forEach((r,i)=>r.style.display=(daysCollapsed&&i>=3)?"none":"");
}else{
btn.style.display="none";
}
}

document.getElementById("addDayBtn").onclick=addDay;
document.getElementById("toggleDaysBtn").onclick=()=>{
daysCollapsed=!daysCollapsed;
updateCollapse();
};

for(let i=1;i<=3;i++){addDay();}

/* ---------- 費用 ---------- */
const feeRows=document.getElementById("feeRows");

function feeRow(){
const row=document.createElement("div");
row.style.display="grid";
row.style.gridTemplateColumns="1fr 100px 100px 100px";
row.style.gap="10px";
row.innerHTML=`
<input class="item" placeholder="項目">
<input class="price" placeholder="單價">
<input class="qty" placeholder="數量" value="1">
<input class="sub" readonly>
`;
row.querySelectorAll(".price,.qty").forEach(el=>el.oninput=calcFee);
return row;
}

function calcFee(){
let total=0;
feeRows.querySelectorAll("div").forEach(r=>{
const p=Number(r.querySelector(".price").value)||0;
const q=Number(r.querySelector(".qty").value)||0;
const sub=p*q;
r.querySelector(".sub").value=sub;
total+=sub;
});
document.getElementById("feeTotal").textContent=total;
}

document.getElementById("addFeeBtn").onclick=()=>feeRows.appendChild(feeRow());
feeRows.appendChild(feeRow());

/* ---------- 簽名 ---------- */
const canvas=document.getElementById("sig");
const ctx=canvas.getContext("2d");
let drawing=false;

canvas.onmousedown=e=>{drawing=true;ctx.moveTo(e.offsetX,e.offsetY);};
canvas.onmousemove=e=>{if(drawing){ctx.lineTo(e.offsetX,e.offsetY);ctx.stroke();}};
window.onmouseup=()=>drawing=false;

document.getElementById("clearBtn").onclick=()=>ctx.clearRect(0,0,canvas.width,canvas.height);

function canvasBlank(){
return canvas.toDataURL().length<2000;
}

/* ---------- 送出 ---------- */
document.getElementById("submitBtn").onclick=async()=>{
if(!document.getElementById("confirm_email").value){
alert("請填Email");return;
}
if(canvasBlank()){
alert("請簽名");return;
}

const payload={
action:"submitHotelCheckoutConfirm",
data:{
customer_email:document.getElementById("confirm_email").value,
signature_png:canvas.toDataURL(),
signed_date:document.getElementById("signed_date").value,
days:[],
fee_total:document.getElementById("feeTotal").textContent
}
};

await fetch(GAS_URL,{
method:"POST",
headers:{"Content-Type":"text/plain;charset=utf-8"},
body:JSON.stringify(payload)
});

document.getElementById("status").textContent="已送出 ✓";
document.getElementById("status").className="status ok";
};
</script>

</body>
</html>
